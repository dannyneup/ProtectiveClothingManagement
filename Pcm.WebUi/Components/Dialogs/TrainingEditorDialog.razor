@using Pcm.Application.Models
<MudDialog>
    <DialogContent>
        <MudForm @bind-IsValid="@_formIsValid" @ref="_form">
            <MudGrid Justify="Justify.FlexStart">
                <MudItem xs="6">
                    <MudTextField T="string"
                                  Label="@Localization.name"
                                  @bind-Value="Training.Name"
                                  Required="true"/>
                    <TrainingTypeAutocomplete TrainingType="@Training.Type" 
                                              TrainingChanged="OnTrainingTypeChanged"
                                              Trainings="Trainings"
                                              Required="true"/>
                </MudItem>
                <MudItem xs="6">
                    <MudTable T="LoadOutPart" Items="Training.LoadOut" @ref="_table"
                              Dense="true"
                              RowEditPreview="OnRowEdit"
                              RowEditCancel="OnRowEditCancel" 
                              CanCancelEdit="true"
                              RowEditCommit="OnRowEditSubmit"
                              IsEditRowSwitchingBlocked="true"
                              ApplyButtonPosition="TableApplyButtonPosition.End">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6"
                                     Color="Color.Primary">
                                @Localization.defaultLoadout
                            </MudText>
                            <MudSpacer/>
                            <MudIconButton Icon="@Icons.Material.Filled.AddCircle"
                                           Disabled="_noItemCategoriesRemaining || _activeRowEdit"
                                           Color="Color.Primary"
                                           OnClick="OnAddLoadOutPart"/>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh>
                                <MudTableSortLabel SortBy="new Func<LoadOutPart, object>(x => x.CategoryName)">@Localization.name</MudTableSortLabel>
                            </MudTh>
                            <MudTh>
                                <MudTableSortLabel SortBy="new Func<LoadOutPart, object>(x => x.Count)">@Localization.count</MudTableSortLabel>
                            </MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="@Localization.name">@context.CategoryName</MudTd>
                            <MudTd DataLabel="@Localization.count">@context.Count</MudTd>
                        </RowTemplate>
                        <RowEditingTemplate>
                            <MudTd DataLabel="@Localization.category">
                                @if (_isAddingLoadOutPart)
                                {
                                    <ItemCategoryAutocomplete ItemCategory="@(new ItemCategory {Id = context.CategoryId, Name = context.CategoryName})"
                                                              ItemCategoryChanged="x => OnCategoryChanged(x, context)"
                                                              ItemCategories="_remainingCategories"
                                                              Required="true"/>
                                }
                                @if (!_isAddingLoadOutPart)
                                {
                                    <MudText>@context.CategoryName</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="@Localization.count">
                                <MudNumericField @bind-Value="@context.Count"
                                                 Min="0" 
                                                 Required="true"/>
                            </MudTd>
                        </RowEditingTemplate>
                    </MudTable>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel"
                   Variant="Variant.Outlined" 
                   Color="Color.Secondary">
            @Localization.cancel
        </MudButton>
        <MudButton OnClick="Submit" 
                   Disabled="@(!_formIsValid || _activeRowEdit)"
                   Variant="Variant.Filled" 
                   Color="Color.Primary">
            @Localization.save
        </MudButton>
    </DialogActions>
</MudDialog>